{
  "name": "Market - Drop Alert via Signal",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -288,
        64
      ],
      "id": "a630c10c-f0e0-4d70-84d7-d2849d1bfd77",
      "name": "Manual Trigger"
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 8
            }
          ]
        }
      },
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        -288,
        240
      ],
      "id": "96ef6172-637f-4cbd-a3f8-f36b5f70b2ab",
      "name": "Daily check"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "symbols",
              "value": "AAPL,MSFT,GOOGL,AMZN,TSLA,IBM,ORCL,GE"
            },
            {
              "name": "category",
              "value": "Stock"
            }
          ],
          "number": [
            {
              "name": "lookback",
              "value": 3
            },
            {
              "name": "threshold",
              "value": 5
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -16,
        64
      ],
      "id": "ed279d99-fdca-4b2d-99e1-9dd76c9a3280",
      "name": "Set stock symbols"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "symbols",
              "value": "SPY,QQQ,DIA,IWM,VOO,EEM,XLK"
            },
            {
              "name": "category",
              "value": "ETF"
            }
          ],
          "number": [
            {
              "name": "lookback",
              "value": 7
            },
            {
              "name": "threshold",
              "value": 5
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -16,
        240
      ],
      "id": "3a42de7e-d6fe-4200-8f98-15a36f1aecbd",
      "name": "Set ETF symbols"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "symbols",
              "value": "BTC-USD,ETH-USD,BNB-USD,SOL-USD,XRP-USD,ADA-USD,DOGE-USD"
            },
            {
              "name": "category",
              "value": "Crypto"
            }
          ],
          "number": [
            {
              "name": "lookback",
              "value": 3
            },
            {
              "name": "threshold",
              "value": 5
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -16,
        432
      ],
      "id": "796dd4ea-59de-42cf-8295-f48369a625a7",
      "name": "Set crypto symbols"
    },
    {
      "parameters": {
        "functionCode": "const entries=[];\nfor (const item of items){\n  const symbols=(item.json.symbols || '').split(',').map(s=>s.trim()).filter(Boolean);\n  const category=item.json.category || 'Unknown';\n  const lookback=Number(item.json.lookback || 3);\n  const threshold=Number(item.json.threshold || 5);\n  for (const symbol of symbols){\n    entries.push({ symbol, category, lookback, threshold });\n  }\n}\nconst unique=[];\nconst seen=new Set();\nfor (const entry of entries){\n  const key=`${entry.category}:${entry.symbol}`;\n  if (!seen.has(key)){\n    seen.add(key);\n    unique.push(entry);\n  }\n}\nreturn [{ entries: unique }];"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        672,
        240
      ],
      "id": "b56015be-8df1-4a36-ad43-514a0e242bc0",
      "name": "Combine symbols"
    },
    {
      "parameters": {
        "functionCode": "const entries=Array.isArray($json.entries) ? $json.entries : [];\nconst dropped=[];\nconst errors=[];\n\nfor (const entry of entries){\n  const symbol=entry.symbol;\n  const category=entry.category || 'Unknown';\n  const lookback=Math.max(1, Number(entry.lookback || 3));\n  const threshold=Math.max(0, Number(entry.threshold || 5));\n  const isCrypto=category.toLowerCase() === 'crypto';\n  const rangeDays=isCrypto ? Math.max(lookback + 5, 10) : Math.max((lookback * 3) + 5, 14);\n  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${rangeDays}d&interval=1d`;\n\n  try {\n    const data=await this.helpers.httpRequest({ method: 'GET', url });\n    const result=data?.chart?.result?.[0];\n    const closes=result?.indicators?.quote?.[0]?.close || [];\n    const timestamps=result?.timestamp || [];\n\n    const points=[];\n    for (let i=0; i<Math.min(closes.length, timestamps.length); i++){\n      const close=closes[i];\n      const ts=timestamps[i];\n      if (typeof close === 'number' && Number.isFinite(close) && close > 0 && typeof ts === 'number'){\n        points.push({ close, ts });\n      }\n    }\n\n    if (points.length < 2){\n      errors.push(`${symbol}: insufficient data`);\n      continue;\n    }\n\n    const latest=points[points.length - 1];\n    let reference;\n\n    if (isCrypto){\n      const targetTs=latest.ts - (lookback * 86400);\n      for (let i=points.length - 2; i>=0; i--){\n        if (points[i].ts <= targetTs){\n          reference=points[i];\n          break;\n        }\n      }\n    } else {\n      const refIndex=points.length - 1 - lookback;\n      if (refIndex >= 0){\n        reference=points[refIndex];\n      }\n    }\n\n    if (!reference || reference.close <= 0){\n      errors.push(`${symbol}: missing reference for ${lookback}d`);\n      continue;\n    }\n\n    const change=((latest.close - reference.close) / reference.close) * 100;\n    if (change <= -threshold){\n      dropped.push(`${category} (${lookback}d): ${symbol} ${change.toFixed(2)}% drop`);\n    }\n  } catch (error){\n    errors.push(`${symbol}: request failed`);\n  }\n}\n\nreturn [{ dropped, errors }];"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        880,
        240
      ],
      "id": "e075aaf9-6ea5-414f-aad6-709d2c472cde",
      "name": "Check drop"
    },
    {
      "parameters": {
        "jsCode": "const dropped = Array.isArray($json.dropped) ? $json.dropped : [];\nconst message = dropped.length\n  ? `Market drops detected:\n${dropped.map((d) => `- ${d}`).join('\\n')}`\n  : 'No significant drops';\n\nreturn [{\n  json: {\n    message,\n    recipient: ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        240
      ],
      "id": "03269f3d-9888-4912-996e-5af3f349172e",
      "name": "Prepare Signal payload"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jEC35MXsssds8HOB",
          "mode": "list",
          "cachedResultUrl": "/workflow/jEC35MXsssds8HOB",
          "cachedResultName": "Signal - Send Message"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1296,
        240
      ],
      "id": "7efb50b6-1716-4489-b2aa-3547a68edf94",
      "name": "Signal - Send Message",
      "alwaysOutputData": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        224,
        224
      ],
      "id": "ce3fc0ce-9bbf-4952-b6cf-d9cbfb695ef7",
      "name": "Merge stocks + ETF"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        464,
        240
      ],
      "id": "1d01bc9d-e888-4d6a-974a-bb978179603c",
      "name": "Merge all categories"
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set stock symbols",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set ETF symbols",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set crypto symbols",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily check": {
      "main": [
        [
          {
            "node": "Set stock symbols",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set ETF symbols",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set crypto symbols",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set stock symbols": {
      "main": [
        [
          {
            "node": "Merge stocks + ETF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set ETF symbols": {
      "main": [
        [
          {
            "node": "Merge stocks + ETF",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set crypto symbols": {
      "main": [
        [
          {
            "node": "Merge all categories",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge stocks + ETF": {
      "main": [
        [
          {
            "node": "Merge all categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge all categories": {
      "main": [
        [
          {
            "node": "Combine symbols",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine symbols": {
      "main": [
        [
          {
            "node": "Check drop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check drop": {
      "main": [
        [
          {
            "node": "Prepare Signal payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Signal payload": {
      "main": [
        [
          {
            "node": "Signal - Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "7758205a-3af3-4723-83b1-dc7f6cc60824",
  "meta": {
    "instanceId": "9a86e2e169064cb50265681a96c982c97ed621c99e4666faa548d134581fb6a5"
  },
  "id": "zwc5QLQMZHnaRefe",
  "tags": []
}